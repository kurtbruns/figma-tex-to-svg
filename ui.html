<style>
  :root {
    --background-color: #38464f;
    --font-color: #e0e0e0;
  }

  html {
    background: var(--background-color);
  }

  h1 {
  font-size: 18px;
}

  h1,
  h2,
  h3,
  h4,
  h5,
  label,
  p {
    color: var(--font-color);
  }

  main {
    display: grid;
    grid-template-rows: auto 1fr auto;
  }

  .container {
    display: flex;
    flex-direction: column;
  }

  textarea {
    background: var(--background-color);
    color: var(--font-color);
    resize: vertical;
  }

  #display {
    text-align: end;
  }

  .controls {
    display: grid;
    grid-template-columns: auto auto;
  }

  #input {
    height: 180px;
    min-height: 120px;
  }

  #output {
    display: block;
    width: 100%;
    min-height: 72px;
    margin-bottom: 1rem;
  }

  #settings-panel .settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem 1.5rem;
    align-items: center;
  }
  #settings-panel .settings-grid > div {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
</style>

<main>
  <h1>TeX to SVG (Dev)</h1>
  <div class="container">
    <textarea id="input">x=\frac{-b \pm \sqrt{b^2-4 a c}}{2 a}</textarea>
    <br>
    <div id="settings-panel" style="border: 1px solid #555; padding: 1rem; margin-bottom: 0.5rem; border-radius: 6px; background: #2a333a;">
      <div class="settings-grid">
        <div>
          <input type="checkbox" id="display" checked="true" onchange="convert()">
          <label for="display">Display style</label>
        </div>
        <div>
          <label for="bgcolor" style="width: 80px;">Background</label>
          <input type="color" id="bgcolor-picker" style="width: 32px; height: 32px; padding: 0; border: none; background: none;">
          <input type="text" id="bgcolor" maxlength="7" style="width: 80px; margin-left: 0.5rem;" onchange="onColorTextChange('bgcolor')">
        </div>
        <div>
          <label for="scale">Scale</label>
          <input type="number" id="scale" min="1" step="0.5" placeholder="1.5" style="width: 60px;">
        </div>
        <div>
          <label for="fontcolor" style="width: 80px;">Font</label>
          <input type="color" id="fontcolor-picker" style="width: 32px; height: 32px; padding: 0; border: none; background: none;">
          <input type="text" id="fontcolor" maxlength="7" style="width: 80px; margin-left: 0.5rem;" onchange="onColorTextChange('fontcolor')">
        </div>

      </div>
    </div>
    <br clear="all">
    <label>Preview</label>
    <div id="output"></div>
  </div>
  <button id="place">Embed</button>
</main>

<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script>
  // Theme defaults in one place
  const THEME_DEFAULTS = {
    window: {
      background: '#38464f',
      font: '#e0e0e0',
    },
    dark: {
      background: '#000000',
      font: '#e0e0e0',
    },
    light: {
      background: '#ffffff',
      font: '#222222',
    },
  };

  let currentTheme = 'dark'; // fallback

  function applyTheme(theme) {
    const defaults = THEME_DEFAULTS[theme] || THEME_DEFAULTS.dark;
    // document.documentElement.style.setProperty('--background-color', defaults.background);
    // document.documentElement.style.setProperty('--font-color', defaults.font);
    document.getElementById('bgcolor').value = defaults.background;
    document.getElementById('fontcolor').value = defaults.font;
    currentTheme = theme;
  }

  function convert() {
    //  Get the TeX input
    var input = document.getElementById("input").value.trim();
    var bgcolor = document.getElementById("bgcolor").value.trim() || THEME_DEFAULTS[currentTheme].background;
    var fontcolor = document.getElementById("fontcolor").value.trim() || THEME_DEFAULTS[currentTheme].font;
    //  Disable the display button until MathJax is done
    var display = document.getElementById("display");
    display.disabled = true;
    //  Clear the old output
    output = document.getElementById('output');
    output.innerHTML = '';
    output.style.background = bgcolor;
    MathJax.texReset();
    var options = MathJax.getMetricsFor(output);
    options.display = display.checked;
    MathJax.tex2svgPromise(`\\color{${fontcolor}} ${input}`, options).then(function (node) {
      output.appendChild(node);
      MathJax.startup.document.clear();
      MathJax.startup.document.updateDocument();
    }).catch(function (err) {
      output.appendChild(document.createElement('pre')).appendChild(document.createTextNode(err.message));
    }).then(function () {
      display.disabled = false;
    });
  }

  // Add input event listener for auto-render
  document.getElementById('input').addEventListener('input', convert);

  // place the svg on the figma canvas
  document.getElementById('place').onclick = () => {
    const tex = document.getElementById("input").value.trim();
    const svg = document.getElementById('output').firstChild.innerHTML;
    const scaleInput = document.getElementById('scale').value;
    const scale = scaleInput ? parseFloat(scaleInput) : 1.5;
    const bgcolor = document.getElementById("bgcolor").value.trim() || THEME_DEFAULTS[currentTheme].background;
    const fontcolor = document.getElementById("fontcolor").value.trim() || THEME_DEFAULTS[currentTheme].font;
    parent.postMessage({ pluginMessage: { tex, svg, scale, bgcolor, fontcolor } }, '*');
  }

  // Helper to sync color pickers and text inputs
  function syncColorInputs(colorId) {
    const picker = document.getElementById(colorId + '-picker');
    const text = document.getElementById(colorId);
    // When picker changes, update text and convert
    picker.addEventListener('input', () => {
      text.value = picker.value;
      convert();
    });
    // When text changes, update picker and convert (handled by onColorTextChange)
    text.value = picker.value;
  }

  function onColorTextChange(colorId) {
    const picker = document.getElementById(colorId + '-picker');
    const text = document.getElementById(colorId);
    // Only update if valid hex
    if (/^#[0-9A-Fa-f]{6}$/.test(text.value)) {
      picker.value = text.value;
      convert();
    }
  }

  // On load, set fallback theme and wait for theme message
  window.onload = () => {
    applyTheme('dark'); // fallback
    // Set color pickers to match text values
    document.getElementById('bgcolor-picker').value = document.getElementById('bgcolor').value || THEME_DEFAULTS[currentTheme].background;
    document.getElementById('fontcolor-picker').value = document.getElementById('fontcolor').value || THEME_DEFAULTS[currentTheme].font;
    syncColorInputs('bgcolor');
    syncColorInputs('fontcolor');
    convert();
  };

  window.addEventListener('message', event => {
    console.log('message', event);
    const { theme } = event.data.pluginMessage || {};
    if (theme === 'dark' || theme === 'light') {
      applyTheme(theme);
      // Update color pickers to match new theme
      document.getElementById('bgcolor-picker').value = document.getElementById('bgcolor').value || THEME_DEFAULTS[theme].background;
      document.getElementById('fontcolor-picker').value = document.getElementById('fontcolor').value || THEME_DEFAULTS[theme].font;
      convert(); // re-render with new colors
    }
  });
</script>